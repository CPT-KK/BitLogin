name: BitLogin Release

on:
  release:
    types:
      - created

env:
  artifact_name: BitLogin

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target_arch: ""
            artifact_name: BitLogin-windows-x64    
            final_executable_name: "BitLogin"
            docker_image: ""
            install-cmd: echo "No dependencies to install on Windows."
            cc: cl
            cxx: cl
            artifact_suffix: .exe
            cmake_arch_flags: ""

          - os: ubuntu-latest
            target_arch: amd64 
            artifact_name: BitLogin-linux-x64
            final_executable_name: "BitLogin"
            docker_image: ubuntu:18.04
            install-cmd: ""
            cc: gcc
            cxx: g++    
            artifact_suffix: ""
            cmake_arch_flags: ""

          - os: macos-14
            target_arch: ""
            artifact_name: BitLogin-macos-universal
            final_executable_name: "BitLogin"
            docker_image: ""
            install-cmd: brew install fmt openssl
            cc: gcc
            cxx: g++ 
            artifact_suffix: ""
            cmake_arch_flags: "-DCMAKE_OSX_ARCHITECTURES='x86_64;arm64'"

          # ===== arm64 (glibc 2.27 via ubuntu:18.04) =====
          - os: ubuntu-latest
            target_arch: aarch64
            artifact_name: BitLogin-linux-aarch64
            final_executable_name: BitLogin
            docker_image: ubuntu:18.04
            install-cmd: ""
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
            artifact_suffix: ""
            cmake_arch_flags: ""

          # ===== armv7 (glibc 2.27 via ubuntu:18.04) =====
          - os: ubuntu-latest
            target_arch: armv7
            artifact_name: BitLogin-linux-armv7
            final_executable_name: BitLogin
            docker_image: ubuntu:18.04
            install-cmd: ""
            cc: arm-linux-gnueabihf-gcc
            cxx: arm-linux-gnueabihf-g++
            artifact_suffix: ""
            cmake_arch_flags: ""

    steps:
      - uses: actions/checkout@v4

      # ===== native builds (Windows / Linux x64 / macOS) =====
      - name: Install dependencies (native)
        if: matrix.target_arch == ''
        run: ${{ matrix.install-cmd }}

      - name: CMake Configure (native)
        if: matrix.target_arch == ''
        run: >
          cmake -B build
          -DCMAKE_C_COMPILER=${{ matrix.cc }}
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_POSITION_INDEPENDENT_CODE=TRUE
          ${{ matrix.cmake_arch_flags }}
          -S .

      - name: CMake Build (native)
        if: matrix.target_arch == ''
        run: cmake --build build --config Release

      # ===== Builds in Ubuntu 18.04 Docker (x64 / arm64 / armv7)=====
      - name: Build Linux (glibc 2.27 via Ubuntu 18.04)
        if: matrix.target_arch != ''
        run: |
            docker run --rm \
            -v "$PWD:/work" \
            -w /work \
            ${{ matrix.docker_image }} \
            bash -c "
                set -eux

                apt-get update
                apt-get install -y build-essential cmake pkg-config ${{ matrix.cc }} ${{ matrix.cxx }} libssl-dev

                if [ '${{ matrix.target_arch }}' != 'amd64' ]; then
                dpkg --add-architecture $([[ '${{ matrix.target_arch }}' == 'armv7' ]] && echo armhf || echo arm64)
                apt-get update
                apt-get install -y \
                    libc6-dev-$([[ '${{ matrix.target_arch }}' == 'armv7' ]] && echo armhf || echo arm64)-cross \
                    libssl-dev:$([[ '${{ matrix.target_arch }}' == 'armv7' ]] && echo armhf || echo arm64)
                fi

                cmake -B build \
                -DCMAKE_SYSTEM_NAME=Linux \
                -DCMAKE_SYSTEM_PROCESSOR=$(
                    [ '${{ matrix.target_arch }}' = 'amd64' ] && echo x86_64 ||
                    [ '${{ matrix.target_arch }}' = 'armv7' ] && echo arm ||
                    echo aarch64
                ) \
                -DCMAKE_C_COMPILER=${{ matrix.cc }} \
                -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_SHARED_LIBS=OFF \
                -DCMAKE_EXE_LINKER_FLAGS='-static-libgcc -static-libstdc++'

                cmake --build build -- -j$(nproc)
            "

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          asset_name: ${{ matrix.artifact_name }}${{ matrix.artifact_suffix }}
          file: build/${{ matrix.final_executable_name }}${{ matrix.artifact_suffix }}
          tag: ${{ github.event.release.tag_name }}
          overwrite: true
